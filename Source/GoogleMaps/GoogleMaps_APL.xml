<?xml version="1.0" encoding="utf-8"?>
<!--AdBox plugin additions-->
<root xmlns:android="http://schemas.android.com/apk/res/android">
	<androidManifestUpdates>

		<addElements tag="application">
				<meta-data android:name="com.google.android.gms.version" 
					android:value="@integer/google_play_services_version" />
			<!--<meta-data android:name="com.google.android.geo.API_KEY"
					android:value="AIzaSyAIahxW93kRq42j2hnpK_5HBDXv4oufb8w"/>-->
			<meta-data android:name="com.google.android.geo.API_KEY"
					android:value="AIzaSyChN7lO4AdIZQR1hIItdThFjbqEjCwqT00"/>     
		</addElements>

		<addElements tag="manifest">
			<uses-permission android:name="android.permission.ACCESS_COARSE_LOCATION" />
			<uses-permission android:name="android.permission.ACCESS_FINE_LOCATION" />
		</addElements>	
	</androidManifestUpdates>

	<prebuildCopies>
		<copyDir src="$S(PluginDir)/Java" dst="$S(BuildDir)" />
	</prebuildCopies>

	<proguardAdditions>
    	<insert>
    		-keep class * extends java.util.ListResourceBundle {
			    protected Object[][] getContents();
			}

			-keep public class com.google.android.gms.common.internal.safeparcel.SafeParcelable {
			    public static final *** NULL;
			}

			-keepnames @com.google.android.gms.common.annotation.KeepName class *
			-keepclassmembernames class * {
			    @com.google.android.gms.common.annotation.KeepName *;
			}

			-keepnames class * implements android.os.Parcelable {
			    public static final ** CREATOR;
			}
	    </insert>
	</proguardAdditions>
	
	<gameActivityImportAdditions>
		<insert>
			import android.os.Bundle;
			import android.view.LayoutInflater;
			import android.widget.FrameLayout;
			import com.google.android.gms.maps.GoogleMap;
			import com.google.android.gms.maps.OnMapReadyCallback;
			import com.google.android.gms.maps.MapFragment;
		</insert>
	</gameActivityImportAdditions>
	<gameActivityOnCreateAdditions>
		<insert>
		// getResourceId() defined in GameActivity.java
		int layoutId = getResourceId("map_frame", "layout", getPackageName());
		int mapContainerId = getResourceId("map", "id", getPackageName());
		Log.debug("layoutId: "+layoutId+", mapContainerId:"+mapContainerId);

		LayoutInflater inflater = (LayoutInflater) 
			_activity.getSystemService(Context.LAYOUT_INFLATER_SERVICE);
		FrameLayout frame = (FrameLayout)inflater.inflate(layoutId, null, false);

		mapDialog = new Dialog(_activity, android.R.style.Theme_Panel);
	    mapDialog.getWindow().addFlags(WindowManager.LayoutParams.FLAG_NOT_TOUCH_MODAL);
	    mapDialog.requestWindowFeature(Window.FEATURE_NO_TITLE);
	    mapDialog.setContentView(frame);

		MapFragment mapFragment = (MapFragment) getFragmentManager().findFragmentById(mapContainerId);
		mapFragment.getMapAsync(new OnMapReadyCallback() {
			@Override
			public void onMapReady(GoogleMap googleMap) {
				Log.debug("Google Map ready");
				//googleMap.setMapType(GoogleMap.MAP_TYPE_TERRAIN);
			}
		});
		mapView = mapFragment.getView();

		</insert>
	</gameActivityOnCreateAdditions>
	
	<gameActivityClassAdditions>
		<insert>
			private GoogleMap googleMap;
			private Dialog mapDialog;
			private View mapView;

			public void AndroidThunkJava_CreateGoogleMap(float posX, float posY, float sizeX, float sizeY, float renderX) {
				Log.debug("In AndroidThunkJava_CreateGoogleMap");
				DisplayMetrics dm = getResources().getDisplayMetrics();
				float scale = dm.widthPixels/renderX;
				
				// Move map
				final WindowManager.LayoutParams wmlp = mapDialog.getWindow().getAttributes();
				wmlp.gravity = Gravity.TOP | Gravity.LEFT;
				wmlp.x = (int)(posX*scale);
				wmlp.y = (int)(posY*scale);
				
				// Set map size
				mapView.getLayoutParams().width = (int)(sizeX*scale);
     			mapView.getLayoutParams().height = (int)(sizeY*scale);
								
				_activity.runOnUiThread(new Runnable()
				{
					@Override
					public void run()
					{
						mapDialog.show();
					}
				});
			}

			public void AndroidThunkJava_RemoveGoogleMap() {
				_activity.runOnUiThread(new Runnable()
				{
					@Override
					public void run()
					{
						if(mapDialog!=null)
							mapDialog.dismiss();
					}
				});
			}
	</insert>
	</gameActivityClassAdditions>
</root>